<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>FastPlaid WASM Demo - mxbai-edge-colbert</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565c0;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .results {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .result-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .score {
            font-weight: bold;
            color: #1976d2;
        }
        .content-preview {
            color: #666;
            font-size: 0.9em;
            margin-top: 8px;
            line-height: 1.4;
        }
        .timing-info {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .stats-table th, .stats-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .stats-table th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>FastPlaid WASM Demo</h1>
    <p>Semantic search with <strong>mixedbread-ai/mxbai-edge-colbert-v0-17m</strong> + FastPlaid</p>

    <div class="container">
        <h3>1. Initialize FastPlaid</h3>
        <button id="initBtn">Initialize WASM Module</button>
        <div id="initStatus"></div>
    </div>

    <div class="container">
        <h3>2. Select Model & Create Index</h3>
        <p>Choose a ColBERT model and create document index:</p>
        <button id="loadMxbaiBtn" disabled style="background: #9c27b0; color: white;">üéØ mixedbread-ai/mxbai-edge-colbert-v0-17m</button>
        <button id="loadColbertBtn" disabled style="background: #ff9800;">üöÄ lightonai/answerai-colbert-small-v1</button>
        <div style="font-size: 0.9em; color: #666; margin-top: 10px;">
            <strong>Model IDs:</strong><br>
            ‚Ä¢ <code>mixedbread-ai/mxbai-edge-colbert-v0-17m</code> - 17M parameters, edge-optimized<br>
            ‚Ä¢ <code>lightonai/answerai-colbert-small-v1</code> - Small ColBERT model, proven working
        </div>
        <div id="indexStatus"></div>
    </div>

    <div class="container">
        <h3>3. Search</h3>
        <p>Enter your search query:</p>
        <textarea id="queryInput" placeholder="Enter your search query here...">machine learning algorithms</textarea>
        <br>
        <label>Top K results: <input type="number" id="topK" value="5" min="1" max="20"></label>
        <br>
        <label><input type="checkbox" id="useFastPlaid" checked> Use FastPlaid (uncheck for direct MaxSim)</label>
        <br>
        <button id="searchBtn" disabled>Search</button>
        <button id="resetStatsBtn" disabled style="background: #ff9800;">Reset Performance Stats</button>
        <div id="searchStatus"></div>
    </div>

    <div class="container">
        <h3>4. Results</h3>
        <div id="results"></div>
    </div>

    <div class="container">
        <h3>5. Performance Statistics</h3>
        <div id="performanceStats"></div>
    </div>

    <div class="container">
        <h3>Technical Details</h3>
        <p><strong>Model:</strong> mixedbread-ai/mxbai-edge-colbert-v0-17m (17M parameters)</p>
        <p><strong>Embedding Dimension:</strong> 384 (optimized for edge deployment)</p>
        <p><strong>Document Count:</strong> 100 documents (ML, ColBERT, pylate, mixedbread + fun content)</p>
        <p><strong>Search Methods:</strong> FastPlaid indexing OR Direct MaxSim computation</p>
        <p><strong>Runtime:</strong> Pure WASM (no server calls)</p>
        <p><strong>Search Algorithm:</strong> ColBERT MaxSim scoring with token-level embeddings</p>
        <p><strong>Pipeline:</strong> Text ‚Üí mxbai-edge-colbert ‚Üí Token Embeddings ‚Üí Search ‚Üí Ranked Results</p>
        <p><strong>Performance Tracking:</strong> Model encoding, query encoding, search time breakdown</p>
        <p><strong>Status:</strong> <span id="techStatus">Demo mode with simulated embeddings</span></p>
        <p><strong>Embeddings:</strong> <span id="embeddingStatus">üé≠ Simulated (no model loaded)</span></p>
        <p><strong>Debug:</strong> <a href="test-pylate.html" target="_blank">Test pylate-rs Integration</a></p>
    </div>

    <script type="module">
        // Import our integration and WASM modules
        import init, { FastPlaidWasm } from './pkg/fast_plaid_rust.js?v=8';

        let fastPlaid = null;
        let mxbaiIntegration = null;
        let documentIndex = null;
        let wasmInitialized = false;

        // Load the integration module
        async function loadIntegration() {
            await import('./mxbai-integration.js');
            // The class is now available on window.MxbaiEdgeColbertIntegration
        }

        // Initialize everything
        async function initializeApp() {
            await loadIntegration();
            setupEventListeners();
        }

        // Set up all event listeners after modules are loaded
        function setupEventListeners() {

        // DOM elements
        const initBtn = document.getElementById('initBtn');
        const loadMxbaiBtn = document.getElementById('loadMxbaiBtn');
        const loadColbertBtn = document.getElementById('loadColbertBtn');
        const searchBtn = document.getElementById('searchBtn');
        const resetStatsBtn = document.getElementById('resetStatsBtn');
        const initStatus = document.getElementById('initStatus');
        const indexStatus = document.getElementById('indexStatus');
        const searchStatus = document.getElementById('searchStatus');
        const results = document.getElementById('results');
        const queryInput = document.getElementById('queryInput');
        const topKInput = document.getElementById('topK');
        const useFastPlaidInput = document.getElementById('useFastPlaid');
        const performanceStats = document.getElementById('performanceStats');

        // Utility functions
        function showError(element, message) {
            element.innerHTML = `<div class="error">Error: ${message}</div>`;
        }

        function showSuccess(element, message) {
            element.innerHTML = `<div class="success">${message}</div>`;
        }

        function showStatus(element, message) {
            element.innerHTML = `<div>${message}</div>`;
        }

        // Initialize WASM and mxbai-edge-colbert
        initBtn.addEventListener('click', async () => {
            try {
                initStatus.innerHTML = '<div>Initializing WASM module and mxbai-edge-colbert...</div>';
                
                // Initialize WASM
                await init();
                fastPlaid = new FastPlaidWasm();
                
                // Make FastPlaid available globally for the integration
                window.fastPlaid = fastPlaid;
                
                // Initialize mxbai-edge-colbert integration
                mxbaiIntegration = new MxbaiEdgeColbertIntegration();
                await mxbaiIntegration.initializeModel();
                
                wasmInitialized = true;
                
                // Update technical status with detailed information
                const modelStatus = mxbaiIntegration.getModelStatus();
                const techStatus = document.getElementById('techStatus');
                if (techStatus) {
                    let statusText = '';
                    if (modelStatus.hasRealModel) {
                        statusText = `üöÄ Real ${modelStatus.modelRepo} loaded via pylate-rs`;
                    } else if (modelStatus.pylateLoaded) {
                        statusText = `üé≠ pylate-rs loaded, but model failed - using simulation`;
                    } else {
                        statusText = `‚ùå pylate-rs failed to load - using simulation`;
                    }
                    techStatus.textContent = statusText;
                }
                
                // Log detailed status for debugging
                console.log('üîç Model Status:', modelStatus);
                
                showSuccess(initStatus, 'WASM module and mxbai-edge-colbert initialized successfully!');
                loadMxbaiBtn.disabled = false;
                loadColbertBtn.disabled = false;
                
            } catch (error) {
                showError(initStatus, `Failed to initialize: ${error.message}`);
                console.error('Initialization error:', error);
            }
        });

        // Load mxbai model and create index
        loadMxbaiBtn.addEventListener('click', async () => {
            await loadModelAndCreateIndex('mixedbread-ai/mxbai-edge-colbert-v0-17m', 'üéØ mxbai-edge-colbert');
        });

        // Load colbert-small model and create index
        loadColbertBtn.addEventListener('click', async () => {
            await loadModelAndCreateIndex('lightonai/answerai-colbert-small-v1', 'üöÄ answerai-colbert-small');
        });

        // Common function to load model and create index
        async function loadModelAndCreateIndex(modelId, displayName) {
            try {
                const indexStartTime = performance.now();
                indexStatus.innerHTML = `<div>Loading ${displayName} and creating document index...</div>`;
                
                // Load the specific model
                await mxbaiIntegration.loadSpecificModel(modelId);
                
                // Update technical status
                const modelStatus = mxbaiIntegration.getModelStatus();
                const techStatus = document.getElementById('techStatus');
                if (techStatus) {
                    let statusText = '';
                    if (modelStatus.hasRealModel) {
                        statusText = `üöÄ Real ${modelStatus.modelRepo} loaded via pylate-rs`;
                    } else if (modelStatus.pylateLoaded) {
                        statusText = `üé≠ pylate-rs loaded, but model failed - using simulation`;
                    } else {
                        statusText = `‚ùå pylate-rs failed to load - using simulation`;
                    }
                    techStatus.textContent = statusText;
                }
                
                // Create sample documents and encode them
                const documents = mxbaiIntegration.createSampleDocuments();
                documentIndex = await mxbaiIntegration.createDocumentIndex(documents);

                // Load document embeddings into FastPlaid WASM
                try {
                    await mxbaiIntegration.createFastPlaidIndex(documentIndex);
                    console.log('‚úÖ FastPlaid index created successfully');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to create FastPlaid index:', error);
                    // Continue - will fall back to Direct MaxSim
                }
                
                const indexTime = performance.now() - indexStartTime;
                const realCount = documentIndex.filter(doc => doc.isReal).length;
                
                showSuccess(indexStatus, 
                    `‚úÖ ${displayName} loaded! ${documents.length} documents indexed (${realCount} real embeddings) in ${indexTime.toFixed(2)}ms`
                );
                searchBtn.disabled = false;
                resetStatsBtn.disabled = false;
                
            } catch (error) {
                showError(indexStatus, `Failed to load ${displayName}: ${error.message}`);
                console.error('Model loading error:', error);
            }
        }

        // Search using mxbai-edge-colbert + FastPlaid or Direct MaxSim
        searchBtn.addEventListener('click', async () => {
            try {
                const query = queryInput.value.trim();
                if (!query) {
                    showError(searchStatus, 'Please enter a search query');
                    return;
                }

                const topK = parseInt(topKInput.value) || 5;
                const useFastPlaid = useFastPlaidInput.checked;

                const requestedMethod = useFastPlaid ? 'FastPlaid' : 'Direct MaxSim';
                searchStatus.innerHTML = `<div>Encoding query with mxbai-edge-colbert and searching using ${requestedMethod}...</div>`;
                results.innerHTML = '';

                if (documentIndex && mxbaiIntegration) {
                    // Use real mxbai-edge-colbert integration
                    const searchResult = await mxbaiIntegration.searchDocuments(
                        query,
                        documentIndex,
                        topK,
                        useFastPlaid
                    );

                    const searchResults = searchResult.results;
                    const timings = searchResult.timings;

                    // Update embedding status
                    const embeddingStatus = document.getElementById('embeddingStatus');
                    const realResults = searchResults.filter(r => r.isReal).length;
                    if (embeddingStatus) {
                        if (realResults > 0) {
                            embeddingStatus.innerHTML = `üöÄ Real ColBERT embeddings (${realResults}/${searchResults.length} results)`;
                        } else {
                            embeddingStatus.innerHTML = `üé≠ Simulated embeddings (model failed)`;
                        }
                    }

                    // Use the actual method from timings (accounts for fallbacks)
                    const actualMethod = timings.method || requestedMethod;
                    showSuccess(searchStatus, `Found ${searchResults.length} results using mxbai-edge-colbert + ${actualMethod}`);
                    displayMxbaiResults(searchResults, query, timings);
                    updatePerformanceStats();
                } else {
                    // Fallback to demo results
                    const embeddingStatus = document.getElementById('embeddingStatus');
                    if (embeddingStatus) {
                        embeddingStatus.innerHTML = `üé≠ Demo mode (no index loaded)`;
                    }
                    showStatus(searchStatus, 'Search demo - showing sample results');
                    displayDemoResults(query, topK);
                }
                
            } catch (error) {
                showError(searchStatus, `Search failed: ${error.message}`);
                console.error('Search error:', error);
            }
        });

        // Reset performance statistics
        resetStatsBtn.addEventListener('click', () => {
            if (mxbaiIntegration) {
                mxbaiIntegration.resetPerformanceStats();
                updatePerformanceStats();
                showSuccess(document.getElementById('searchStatus'), 'Performance statistics reset');
            }
        });

        function displayResults(searchResults, query) {
            if (!searchResults || searchResults.length === 0) {
                results.innerHTML = '<div>No results found.</div>';
                return;
            }

            let html = '<div class="results">';
            searchResults.forEach((result, index) => {
                html += `
                    <div class="result-item">
                        <div><strong>Result ${index + 1}</strong></div>
                        <div>Document ID: ${result.passage_ids?.[0] || 'N/A'}</div>
                        <div class="score">Score: ${result.scores?.[0]?.toFixed(4) || 'N/A'}</div>
                    </div>
                `;
            });
            html += '</div>';
            results.innerHTML = html;
        }

        function displayMxbaiResults(searchResults, query, timings) {
            let html = '<div class="results">';
            html += `<div><strong>mxbai-edge-colbert Results for:</strong> "${query}"</div>`;
            
            // Display timing information
            if (timings) {
                html += `
                    <div class="timing-info">
                        <strong>‚è±Ô∏è Performance Breakdown:</strong><br>
                        Query Encoding: ${timings.queryEncoding.toFixed(2)}ms<br>
                        Search Time (${timings.method}): ${timings.searchTime.toFixed(2)}ms<br>
                        Total Time: ${timings.totalTime.toFixed(2)}ms
                    </div>
                `;
            }
            
            searchResults.forEach((result, index) => {
                const statusIcon = result.isReal ? 'üöÄ' : 'üé≠';
                const statusText = result.isReal ? 'Real pylate-rs embeddings' : 'Simulated embeddings';
                const contentPreview = result.content ? 
                    (result.content.length > 200 ? result.content.substring(0, 200) + '...' : result.content) : 
                    'No content available';
                
                html += `
                    <div class="result-item">
                        <div><strong>${result.title}</strong></div>
                        <div>Document ID: ${result.id}</div>
                        <div class="score">ColBERT MaxSim Score: ${result.score.toFixed(4)}</div>
                        <div class="content-preview">${contentPreview}</div>
                        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                            ${statusIcon} ${statusText} | Tokens: ${result.numTokens || 'N/A'}
                            ${result.encodingTime ? ` | Encoding: ${result.encodingTime.toFixed(2)}ms` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            results.innerHTML = html;
        }

        function updatePerformanceStats() {
            if (!mxbaiIntegration) return;

            const stats = mxbaiIntegration.getPerformanceStats();
            let html = '<table class="stats-table">';
            html += '<tr><th>Metric</th><th>Count</th><th>Avg (ms)</th><th>Min (ms)</th><th>Max (ms)</th></tr>';

            const metrics = [
                { name: 'Model Encoding', data: stats.modelEncoding },
                { name: 'Query Encoding', data: stats.queryEncoding },
                { name: 'Search Time', data: stats.searchTime },
                { name: 'Total Search Time', data: stats.totalSearchTime },
                { name: 'Index Creation', data: stats.indexTime }
            ];

            metrics.forEach(metric => {
                html += `
                    <tr>
                        <td>${metric.name}</td>
                        <td>${metric.data.count}</td>
                        <td>${metric.data.avg}</td>
                        <td>${metric.data.min}</td>
                        <td>${metric.data.max}</td>
                    </tr>
                `;
            });

            html += '</table>';

            // Add memory comparison if available
            if (stats.memory && stats.memory.fastPlaid.totalBytes > 0) {
                html += '<h4 style="margin-top: 20px;">Index Memory Comparison</h4>';
                html += '<table class="stats-table">';
                html += '<tr><th>Method</th><th>Total Size</th><th>Embeddings</th><th>Metadata</th><th>Efficiency</th></tr>';

                html += `
                    <tr>
                        <td><strong>FastPlaid (WASM)</strong></td>
                        <td>${stats.memory.fastPlaid.total}</td>
                        <td>${stats.memory.fastPlaid.embeddings}</td>
                        <td>${stats.memory.fastPlaid.metadata}</td>
                        <td style="color: #2e7d32; font-weight: bold;">
                            ${stats.memory.savings ? `‚Üì ${stats.memory.savings.percent}% smaller` : 'Baseline'}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Direct MaxSim (JS)</strong></td>
                        <td>${stats.memory.directMaxSim.total}</td>
                        <td>${stats.memory.directMaxSim.embeddings}</td>
                        <td>${stats.memory.directMaxSim.metadata}</td>
                        <td style="color: #c62828;">
                            ${stats.memory.savings ? `Baseline (uses ${stats.memory.directMaxSim.total})` : '-'}
                        </td>
                    </tr>
                `;

                if (stats.memory.savings) {
                    html += `
                        <tr style="background-color: #e8f5e8;">
                            <td colspan="4"><strong>Memory Savings with FastPlaid:</strong></td>
                            <td style="color: #2e7d32; font-weight: bold;">
                                ${stats.memory.savings.absolute} (${stats.memory.savings.percent}%)
                            </td>
                        </tr>
                    `;
                }

                html += '</table>';

                // Add technical details
                html += `
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <strong>Technical Details:</strong><br>
                        ‚Ä¢ Documents: ${stats.memory.fastPlaid.documentCount}<br>
                        ‚Ä¢ Embedding Dimension: ${stats.memory.fastPlaid.embeddingDim}<br>
                        ‚Ä¢ FastPlaid: Uses Float32Array (4 bytes/float) in WASM linear memory<br>
                        ‚Ä¢ Direct MaxSim: Uses JavaScript numbers (8 bytes/float) in JS heap<br>
                        ‚Ä¢ Memory savings: ${stats.memory.savings ? '~' + stats.memory.savings.percent + '% reduction' : 'N/A'}
                    </div>
                `;
            }

            performanceStats.innerHTML = html;
        }

        function displayDemoResults(query, topK) {
            // Demo results to show the UI
            const demoResults = [
                { id: 1, title: "Introduction to Machine Learning", score: 0.9234 },
                { id: 2, title: "Deep Learning Algorithms Overview", score: 0.8876 },
                { id: 3, title: "Neural Networks and Backpropagation", score: 0.8654 },
                { id: 4, title: "Supervised Learning Techniques", score: 0.8432 },
                { id: 5, title: "Unsupervised Learning Methods", score: 0.8123 }
            ].slice(0, topK);

            let html = '<div class="results">';
            html += `<div><strong>Demo Results for:</strong> "${query}"</div><br>`;
            demoResults.forEach((result, index) => {
                html += `
                    <div class="result-item">
                        <div><strong>${result.title}</strong></div>
                        <div>Document ID: ${result.id}</div>
                        <div class="score">ColBERT Score: ${result.score.toFixed(4)}</div>
                    </div>
                `;
            });
            html += '</div>';
            results.innerHTML = html;
        }

        // Show initial instructions
        showStatus(initStatus, 'Click "Initialize WASM Module" to start');
        updatePerformanceStats(); // Initialize empty stats table
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>