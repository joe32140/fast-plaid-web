<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>FastPlaid WASM Demo - mxbai-edge-colbert</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565c0;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .results {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .score {
            font-weight: bold;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <h1>FastPlaid WASM Demo</h1>
    <p>Semantic search with <strong>mixedbread-ai/mxbai-edge-colbert-v0-17m</strong> + FastPlaid</p>

    <div class="container">
        <h3>1. Initialize FastPlaid</h3>
        <button id="initBtn">Initialize WASM Module</button>
        <div id="initStatus"></div>
    </div>

    <div class="container">
        <h3>2. Load Index</h3>
        <p>In a real implementation, this would load a pre-built FastPlaid index.</p>
        <button id="loadIndexBtn" disabled>Load Sample Index</button>
        <button id="forceRealModelBtn" disabled style="background: #ff9800;">🚀 Force Real Model</button>
        <button id="tryMxbaiBtn" disabled style="background: #9c27b0; color: white;">🎯 Try mxbai Model</button>
        <div id="indexStatus"></div>
    </div>

    <div class="container">
        <h3>3. Search</h3>
        <p>Enter your search query:</p>
        <textarea id="queryInput" placeholder="Enter your search query here...">machine learning algorithms</textarea>
        <br>
        <label>Top K results: <input type="number" id="topK" value="5" min="1" max="20"></label>
        <br>
        <button id="searchBtn" disabled>Search</button>
        <div id="searchStatus"></div>
    </div>

    <div class="container">
        <h3>4. Results</h3>
        <div id="results"></div>
    </div>

    <div class="container">
        <h3>Technical Details</h3>
        <p><strong>Model:</strong> mixedbread-ai/mxbai-edge-colbert-v0-17m (17M parameters)</p>
        <p><strong>Embedding Dimension:</strong> 384 (optimized for edge deployment)</p>
        <p><strong>Index:</strong> FastPlaid with IVF clustering + residual quantization</p>
        <p><strong>Runtime:</strong> Pure WASM (no server calls)</p>
        <p><strong>Search Algorithm:</strong> ColBERT MaxSim scoring</p>
        <p><strong>Pipeline:</strong> Text → mxbai-edge-colbert → Token Embeddings → FastPlaid → Ranked Results</p>
        <p><strong>Status:</strong> <span id="techStatus">Demo mode with simulated embeddings</span></p>
        <p><strong>Debug:</strong> <a href="test-pylate.html" target="_blank">Test pylate-rs Integration</a></p>
    </div>

    <script type="module">
        // Import our integration and WASM modules
        import('./mxbai-integration.js');
        import init, { FastPlaidWasm } from './pkg/fast_plaid_rust.js';

        let fastPlaid = null;
        let mxbaiIntegration = null;
        let documentIndex = null;
        let wasmInitialized = false;

        // DOM elements
        const initBtn = document.getElementById('initBtn');
        const loadIndexBtn = document.getElementById('loadIndexBtn');
        const forceRealModelBtn = document.getElementById('forceRealModelBtn');
        const tryMxbaiBtn = document.getElementById('tryMxbaiBtn');
        const searchBtn = document.getElementById('searchBtn');
        const initStatus = document.getElementById('initStatus');
        const indexStatus = document.getElementById('indexStatus');
        const searchStatus = document.getElementById('searchStatus');
        const results = document.getElementById('results');
        const queryInput = document.getElementById('queryInput');
        const topKInput = document.getElementById('topK');

        // Utility functions
        function showError(element, message) {
            element.innerHTML = `<div class="error">Error: ${message}</div>`;
        }

        function showSuccess(element, message) {
            element.innerHTML = `<div class="success">${message}</div>`;
        }

        function showStatus(element, message) {
            element.innerHTML = `<div>${message}</div>`;
        }

        // Initialize WASM and mxbai-edge-colbert
        initBtn.addEventListener('click', async () => {
            try {
                initStatus.innerHTML = '<div>Initializing WASM module and mxbai-edge-colbert...</div>';
                
                // Initialize WASM
                await init();
                fastPlaid = new FastPlaidWasm();
                
                // Initialize mxbai-edge-colbert integration
                mxbaiIntegration = new MxbaiEdgeColbertIntegration();
                await mxbaiIntegration.initializeModel();
                
                wasmInitialized = true;
                
                // Update technical status with detailed information
                const modelStatus = mxbaiIntegration.getModelStatus();
                const techStatus = document.getElementById('techStatus');
                if (techStatus) {
                    let statusText = '';
                    if (modelStatus.hasRealModel) {
                        statusText = `🚀 Real ${modelStatus.modelRepo} loaded via pylate-rs`;
                    } else if (modelStatus.pylateLoaded) {
                        statusText = `🎭 pylate-rs loaded, but model failed - using simulation`;
                    } else {
                        statusText = `❌ pylate-rs failed to load - using simulation`;
                    }
                    techStatus.textContent = statusText;
                }
                
                // Log detailed status for debugging
                console.log('🔍 Model Status:', modelStatus);
                
                showSuccess(initStatus, 'WASM module and mxbai-edge-colbert initialized successfully!');
                loadIndexBtn.disabled = false;
                forceRealModelBtn.disabled = false;
                tryMxbaiBtn.disabled = false;
                
            } catch (error) {
                showError(initStatus, `Failed to initialize: ${error.message}`);
                console.error('Initialization error:', error);
            }
        });

        // Load index and create document embeddings
        loadIndexBtn.addEventListener('click', async () => {
            try {
                indexStatus.innerHTML = '<div>Creating document index with mxbai-edge-colbert...</div>';
                
                // Create sample documents and encode them
                const documents = mxbaiIntegration.createSampleDocuments();
                documentIndex = await mxbaiIntegration.createDocumentIndex(documents);
                
                // Load into FastPlaid (placeholder for now)
                const dummyIndexBytes = new Uint8Array([1, 2, 3, 4, 5]);
                try {
                    await fastPlaid.load_index(dummyIndexBytes);
                } catch (error) {
                    // Expected - placeholder implementation
                }
                
                showSuccess(indexStatus, `Document index created! ${documents.length} documents encoded with mxbai-edge-colbert`);
                searchBtn.disabled = false;
                
            } catch (error) {
                showError(indexStatus, `Failed to create index: ${error.message}`);
                console.error('Index creation error:', error);
            }
        });

        // Force real model loading
        forceRealModelBtn.addEventListener('click', async () => {
            try {
                indexStatus.innerHTML = '<div>🔄 Force retrying real model loading...</div>';
                
                const success = await mxbaiIntegration.forceRealModel();
                if (success) {
                    showSuccess(indexStatus, '🚀 Real model loaded successfully! Try creating index again.');
                } else {
                    showError(indexStatus, '❌ Real model loading failed. Check console for details.');
                }
                
            } catch (error) {
                showError(indexStatus, `Force retry failed: ${error.message}`);
                console.error('Force retry error:', error);
            }
        });

        // Try mxbai model specifically
        tryMxbaiBtn.addEventListener('click', async () => {
            try {
                indexStatus.innerHTML = '<div>🎯 Trying mxbai-edge-colbert-v0-17m specifically...</div>';
                
                const success = await mxbaiIntegration.tryMxbaiModel();
                if (success) {
                    showSuccess(indexStatus, '🎉 mxbai-edge-colbert model loaded! Try creating index again.');
                    
                    // Update technical status
                    const modelStatus = mxbaiIntegration.getModelStatus();
                    const techStatus = document.getElementById('techStatus');
                    if (techStatus) {
                        techStatus.textContent = `🚀 Real ${modelStatus.modelRepo} loaded via pylate-rs`;
                    }
                } else {
                    showError(indexStatus, '❌ mxbai model loading failed. Check console for details.');
                }
                
            } catch (error) {
                showError(indexStatus, `mxbai model failed: ${error.message}`);
                console.error('mxbai model error:', error);
            }
        });

        // Search using mxbai-edge-colbert + FastPlaid
        searchBtn.addEventListener('click', async () => {
            try {
                const query = queryInput.value.trim();
                if (!query) {
                    showError(searchStatus, 'Please enter a search query');
                    return;
                }

                const topK = parseInt(topKInput.value) || 5;
                
                searchStatus.innerHTML = '<div>Encoding query with mxbai-edge-colbert and searching...</div>';
                results.innerHTML = '';

                if (documentIndex && mxbaiIntegration) {
                    // Use real mxbai-edge-colbert integration
                    const searchResults = await mxbaiIntegration.searchDocuments(
                        query, 
                        documentIndex, 
                        topK
                    );
                    
                    showSuccess(searchStatus, `Found ${searchResults.length} results using mxbai-edge-colbert + FastPlaid`);
                    displayMxbaiResults(searchResults, query);
                } else {
                    // Fallback to demo results
                    showStatus(searchStatus, 'Search demo - showing sample results');
                    displayDemoResults(query, topK);
                }
                
            } catch (error) {
                showError(searchStatus, `Search failed: ${error.message}`);
                console.error('Search error:', error);
            }
        });

        function displayResults(searchResults, query) {
            if (!searchResults || searchResults.length === 0) {
                results.innerHTML = '<div>No results found.</div>';
                return;
            }

            let html = '<div class="results">';
            searchResults.forEach((result, index) => {
                html += `
                    <div class="result-item">
                        <div><strong>Result ${index + 1}</strong></div>
                        <div>Document ID: ${result.passage_ids?.[0] || 'N/A'}</div>
                        <div class="score">Score: ${result.scores?.[0]?.toFixed(4) || 'N/A'}</div>
                    </div>
                `;
            });
            html += '</div>';
            results.innerHTML = html;
        }

        function displayMxbaiResults(searchResults, query) {
            let html = '<div class="results">';
            html += `<div><strong>mxbai-edge-colbert Results for:</strong> "${query}"</div><br>`;
            searchResults.forEach((result, index) => {
                const statusIcon = result.isReal ? '🚀' : '🎭';
                const statusText = result.isReal ? 'Real pylate-rs embeddings' : 'Simulated embeddings';
                html += `
                    <div class="result-item">
                        <div><strong>${result.title}</strong></div>
                        <div>Document ID: ${result.id}</div>
                        <div class="score">ColBERT MaxSim Score: ${result.score.toFixed(4)}</div>
                        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                            ${statusIcon} ${statusText}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            results.innerHTML = html;
        }

        function displayDemoResults(query, topK) {
            // Demo results to show the UI
            const demoResults = [
                { id: 1, title: "Introduction to Machine Learning", score: 0.9234 },
                { id: 2, title: "Deep Learning Algorithms Overview", score: 0.8876 },
                { id: 3, title: "Neural Networks and Backpropagation", score: 0.8654 },
                { id: 4, title: "Supervised Learning Techniques", score: 0.8432 },
                { id: 5, title: "Unsupervised Learning Methods", score: 0.8123 }
            ].slice(0, topK);

            let html = '<div class="results">';
            html += `<div><strong>Demo Results for:</strong> "${query}"</div><br>`;
            demoResults.forEach((result, index) => {
                html += `
                    <div class="result-item">
                        <div><strong>${result.title}</strong></div>
                        <div>Document ID: ${result.id}</div>
                        <div class="score">ColBERT Score: ${result.score.toFixed(4)}</div>
                    </div>
                `;
            });
            html += '</div>';
            results.innerHTML = html;
        }

        // Show initial instructions
        showStatus(initStatus, 'Click "Initialize WASM Module" to start');
    </script>
</body>
</html>