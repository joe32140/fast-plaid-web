<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Test pylate-rs Integration</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>pylate-rs Integration Test</h1>
    
    <button onclick="testPylateImport()">1. Test pylate-rs Import</button>
    <button onclick="testModelLoading()">2. Test Model Loading</button>
    <button onclick="testQueryEncoding()">3. Test Query Encoding</button>
    <button onclick="testDocumentEncoding()">4. Test Document Encoding</button>
    
    <div id="logs"></div>

    <script type="module">
        let ColBERT = null;
        let model = null;
        
        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }
        
        window.testPylateImport = async function() {
            try {
                log('🚀 Testing pylate-rs import...');
                
                const pylateModule = await import('./node_modules/pylate-rs/pylate_rs.js');
                log('✅ pylate-rs module imported');
                
                await pylateModule.default();
                log('✅ WASM initialized');
                
                ColBERT = pylateModule.ColBERT;
                log(`✅ ColBERT class available: ${typeof ColBERT}`);
                
                log('🎉 pylate-rs import test successful!', 'success');
                
            } catch (error) {
                log(`❌ pylate-rs import failed: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        window.testModelLoading = async function() {
            if (!ColBERT) {
                log('❌ ColBERT not available. Run import test first.', 'error');
                return;
            }
            
            try {
                log('📥 Testing model loading with lightonai/answerai-colbert-small-v1...');
                
                const modelRepo = 'lightonai/answerai-colbert-small-v1';
                const requiredFiles = [
                    'tokenizer.json',
                    'model.safetensors',
                    'config.json',
                    'config_sentence_transformers.json',
                    '1_Dense/model.safetensors',
                    '1_Dense/config.json',
                    'special_tokens_map.json',
                ];
                
                log(`🔍 Fetching ${requiredFiles.length} files...`);
                
                const responses = await Promise.all(
                    requiredFiles.map(file => 
                        fetch(`https://huggingface.co/${modelRepo}/resolve/main/${file}`)
                    )
                );
                
                // Check responses
                for (let i = 0; i < responses.length; i++) {
                    const response = responses[i];
                    const file = requiredFiles[i];
                    if (!response.ok) {
                        throw new Error(`Failed to fetch ${file}: ${response.status}`);
                    }
                    log(`✅ Fetched ${file} (${response.headers.get('content-length')} bytes)`);
                }
                
                log('🔧 Converting to Uint8Arrays...');
                const modelFiles = await Promise.all(
                    responses.map(res => res.arrayBuffer().then(b => new Uint8Array(b)))
                );
                
                log('🏗️ Initializing ColBERT model...');
                const [tokenizer, modelData, config, stConfig, dense, denseConfig, tokensConfig] = modelFiles;
                
                model = new ColBERT(
                    modelData,
                    dense,
                    tokenizer,
                    config,
                    stConfig,
                    denseConfig,
                    tokensConfig,
                    32
                );
                
                log('🎉 Model loading test successful!', 'success');
                
            } catch (error) {
                log(`❌ Model loading failed: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        window.testQueryEncoding = async function() {
            if (!model) {
                log('❌ Model not loaded. Run model loading test first.', 'error');
                return;
            }
            
            try {
                log('🔤 Testing query encoding...');
                
                const testQuery = "What is machine learning?";
                log(`📝 Encoding query: "${testQuery}"`);
                
                // Try different API formats to find the working one
                let embeddings;
                try {
                    log('🧪 Trying format 1: {sentences: [...]}');
                    embeddings = await model.encode({
                        sentences: [testQuery]
                    }, true);
                } catch (e1) {
                    log(`❌ Format 1 failed: ${e1.message}`);
                    try {
                        log('🧪 Trying format 2: [sentences], is_query');
                        embeddings = await model.encode([testQuery], true);
                    } catch (e2) {
                        log(`❌ Format 2 failed: ${e2.message}`);
                        try {
                            log('🧪 Trying format 3: {sentences: [...], is_query: true}');
                            embeddings = await model.encode({
                                sentences: [testQuery],
                                is_query: true
                            });
                        } catch (e3) {
                            log(`❌ Format 3 failed: ${e3.message}`);
                            throw new Error(`All formats failed. Last error: ${e3.message}`);
                        }
                    }
                }
                
                log(`✅ Query encoding successful!`);
                log(`🔍 Embeddings type: ${typeof embeddings}`);
                log(`🔍 Embeddings structure:`, embeddings);
                
                // Handle different possible return formats
                let embeddingArray;
                if (Array.isArray(embeddings)) {
                    embeddingArray = embeddings;
                } else if (embeddings.length !== undefined) {
                    embeddingArray = Array.from(embeddings);
                } else if (embeddings[0] && Array.isArray(embeddings[0])) {
                    embeddingArray = embeddings[0];
                } else {
                    log(`⚠️ Unknown embeddings format, trying to convert...`);
                    embeddingArray = Object.values(embeddings);
                }
                
                log(`📊 Generated ${embeddingArray.length} values`);
                if (embeddingArray.length > 0) {
                    log(`📊 First 10 values: [${embeddingArray.slice(0, 10).map(x => x.toFixed(4)).join(', ')}...]`);
                }
                
                log('🎉 Query encoding test successful!', 'success');
                
            } catch (error) {
                log(`❌ Query encoding failed: ${error.message}`, 'error');
                console.error(error);
            }
        };

        window.testDocumentEncoding = async function() {
            if (!model) {
                log('❌ Model not loaded. Run model loading test first.', 'error');
                return;
            }
            
            try {
                log('📄 Testing document encoding...');
                
                const testDoc = "Machine learning is a subset of artificial intelligence that enables computers to learn from data.";
                log(`📝 Encoding document: "${testDoc.substring(0, 50)}..."`);
                
                // Try different API formats to find the working one
                let embeddings;
                try {
                    log('🧪 Trying format 1: {sentences: [...]}');
                    embeddings = await model.encode({
                        sentences: [testDoc]
                    }, false);
                } catch (e1) {
                    log(`❌ Format 1 failed: ${e1.message}`);
                    try {
                        log('🧪 Trying format 2: [sentences], is_query');
                        embeddings = await model.encode([testDoc], false);
                    } catch (e2) {
                        log(`❌ Format 2 failed: ${e2.message}`);
                        try {
                            log('🧪 Trying format 3: {sentences: [...], is_query: false}');
                            embeddings = await model.encode({
                                sentences: [testDoc],
                                is_query: false
                            });
                        } catch (e3) {
                            log(`❌ Format 3 failed: ${e3.message}`);
                            throw new Error(`All formats failed. Last error: ${e3.message}`);
                        }
                    }
                }
                
                log(`✅ Document encoding successful!`);
                log(`🔍 Embeddings type: ${typeof embeddings}`);
                log(`🔍 Embeddings structure:`, embeddings);
                
                // Handle different possible return formats
                let embeddingArray;
                if (Array.isArray(embeddings)) {
                    embeddingArray = embeddings;
                } else if (embeddings.length !== undefined) {
                    embeddingArray = Array.from(embeddings);
                } else if (embeddings[0] && Array.isArray(embeddings[0])) {
                    embeddingArray = embeddings[0];
                } else {
                    log(`⚠️ Unknown embeddings format, trying to convert...`);
                    embeddingArray = Object.values(embeddings);
                }
                
                log(`📊 Generated ${embeddingArray.length} values`);
                if (embeddingArray.length > 0) {
                    log(`📊 First 10 values: [${embeddingArray.slice(0, 10).map(x => x.toFixed(4)).join(', ')}...]`);
                }
                
                log('🎉 Document encoding test successful!', 'success');
                
            } catch (error) {
                log(`❌ Document encoding failed: ${error.message}`, 'error');
                console.error(error);
            }
        };
    </script>
</body>
</html>